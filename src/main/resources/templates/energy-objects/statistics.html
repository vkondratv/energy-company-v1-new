<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Статистика энергообъектов - ЭнергоКомпания</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --info-color: #7209b7;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-container {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .stat-card {
            border-radius: 15px;
            border: none;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2) !important;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .progress-thin {
            height: 6px;
            border-radius: 3px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }

        .type-aes { background-color: rgba(245, 158, 11, 0.1); color: #d97706; }
        .type-ges { background-color: rgba(59, 130, 246, 0.1); color: #2563eb; }
        .type-tes { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .type-ses { background-color: rgba(245, 158, 11, 0.1); color: #d97706; }
        .type-tetc { background-color: rgba(16, 185, 129, 0.1); color: #059669; }
        .type-ves { background-color: rgba(139, 92, 246, 0.1); color: #7c3aed; }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-active { background-color: #10b981; }
        .status-inactive { background-color: #ef4444; }

        .distribution-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .distribution-fill {
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 10px 20px;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }

        .comparison-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
        }

        .comparison-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0;
        }

        .comparison-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .trend-up {
            color: #10b981;
        }

        .trend-down {
            color: #ef4444;
        }

        .print-only {
            display: none;
        }

        @media print {
            body {
                background: white !important;
            }
            .dashboard-container {
                box-shadow: none;
                margin: 0;
                padding: 10px;
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
        }
    </style>
</head>
<body>
<!-- Навигация -->
<nav class="navbar navbar-expand-lg navbar-dark no-print">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">
            <i class="bi bi-lightning-charge-fill me-2"></i>
            <span class="fw-bold">ЭнергоКомпания</span>
            <small class="ms-2 text-warning">Статистика</small>
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" th:href="@{/energy-objects}">
                <i class="bi bi-lightbulb me-1"></i>Энергообъекты
            </a>
            <a class="nav-link" th:href="@{/}" sec:authorize="isAuthenticated()">
                <i class="bi bi-house me-1"></i>Главная
            </a>
            <a class="nav-link" th:href="@{/energy-objects/statistics}" sec:authorize="hasRole('ADMIN')">
                <i class="bi bi-shield-lock me-1"></i>Админ
            </a>
        </div>
    </div>
</nav>

<!-- Заголовок для печати -->
<div class="print-only text-center mb-4">
    <h1>Статистика энергообъектов</h1>
    <p class="text-muted">Отчет от <span th:text="${#temporals.format(#temporals.createToday(), 'dd.MM.yyyy HH:mm')}"></span></p>
</div>

<div class="container">
    <div class="dashboard-container">
        <!-- Заголовок -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="fw-bold mb-2" style="color: var(--primary-color);">
                    <i class="bi bi-bar-chart-fill me-2"></i>Статистика энергообъектов
                </h1>
                <p class="text-muted">
                    Аналитическая информация по всем энергетическим объектам компании.
                    Данные обновляются в реальном времени.
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Данные на: <span th:text="${#temporals.format(#temporals.createToday(), 'dd.MM.yyyy HH:mm')}"></span>
                </small>
            </div>
        </div>

        <!-- Сообщения об ошибках -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Если нет данных -->
        <div th:if="${totalObjects == null or totalObjects == 0}" class="text-center py-5">
            <i class="bi bi-bar-chart text-muted" style="font-size: 4rem;"></i>
            <h3 class="text-muted mt-3">Нет данных для отображения</h3>
            <p class="text-muted mb-4">Добавьте энергообъекты для просмотра статистики</p>
            <a th:href="@{/energy-objects/create}" class="btn btn-primary" sec:authorize="hasAnyRole('MODERATOR', 'ADMIN')">
                <i class="bi bi-plus-circle me-1"></i>Добавить первый объект
            </a>
        </div>

        <!-- Основная статистика -->
        <div th:if="${totalObjects != null and totalObjects > 0}">
            <!-- Ключевые показатели -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="stat-label">Всего объектов</p>
                                    <h2 class="stat-value" th:text="${totalObjects}">0</h2>
                                    <small class="text-muted">100% от общего количества</small>
                                </div>
                                <div class="stat-icon text-primary">
                                    <i class="bi bi-building"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="distribution-bar">
                                    <div class="distribution-fill" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="stat-label">Активных объектов</p>
                                    <h2 class="stat-value text-success" th:text="${activeObjects}">0</h2>
                                    <small class="text-muted">
                                        <span class="status-dot status-active"></span>
                                        <span th:text="${activePercentage} + '% от общего количества'">0%</span>
                                    </small>
                                </div>
                                <div class="stat-icon text-success">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="distribution-bar">
                                    <div class="distribution-fill bg-success" th:style="'width: ' + ${activePercentage} + '%;'"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="stat-label">Общая мощность</p>
                                    <h2 class="stat-value text-info"
                                        th:text="${#numbers.formatDecimal(totalPower, 1, 2)} + ' МВт'">0 МВт</h2>
                                    <small class="text-muted">
                                        <i class="bi bi-lightning me-1"></i>
                                        Активных: <span th:text="${#numbers.formatDecimal(totalActivePower, 1, 2)} + ' МВт'">0 МВт</span>
                                    </small>
                                </div>
                                <div class="stat-icon text-info">
                                    <i class="bi bi-lightning-charge"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="progress progress-thin">
                                    <div class="progress-bar bg-info"
                                         th:style="'width: ' + ${(totalActivePower / totalPower) * 100} + '%;'"
                                         th:title="'Доля активной мощности: ' + ${#numbers.formatDecimal((totalActivePower / totalPower) * 100, 1, 1)} + '%'">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p class="stat-label">Средний КПД</p>
                                    <h2 class="stat-value text-warning"
                                        th:text="${#numbers.formatDecimal(averageEfficiency, 1, 1)} + '%'">0%</h2>
                                    <small class="text-muted">
                                        <i class="bi bi-percent me-1"></i>
                                        Средняя эффективность
                                    </small>
                                </div>
                                <div class="stat-icon text-warning">
                                    <i class="bi bi-speedometer"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="distribution-bar">
                                    <div class="distribution-fill bg-warning"
                                         th:style="'width: ' + ${averageEfficiency} + '%;'"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Графики и распределение -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-pie-chart-fill text-primary me-2"></i>
                                Распределение по типам объектов
                            </h5>
                            <div class="chart-container">
                                <canvas id="typeDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-activity text-success me-2"></i>
                                Состояние объектов
                            </h5>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div class="mt-3 text-center">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="p-3 bg-success bg-opacity-10 rounded">
                                            <h3 th:text="${activeObjects}">0</h3>
                                            <small class="text-success">Активных</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-3 bg-danger bg-opacity-10 rounded">
                                            <h3 th:text="${inactiveObjects}">0</h3>
                                            <small class="text-danger">Неактивных</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Детальная таблица -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="bi bi-table text-info me-2"></i>
                                Детальная статистика по типам объектов
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                    <tr>
                                        <th>Тип объекта</th>
                                        <th class="text-center">Количество</th>
                                        <th class="text-center">Доля</th>
                                        <th class="text-center">Мощность (МВт)</th>
                                        <th class="text-center">Средний КПД</th>
                                        <th class="text-center">Распределение</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="entry : ${typeCounts}">
                                        <td>
                                                <span class="type-badge" th:classappend="${'type-' + entry.key.toLowerCase()}"
                                                      th:text="${entry.key}">Тип</span>
                                        </td>
                                        <td class="text-center">
                                            <strong th:text="${entry.value}">0</strong>
                                            <div class="small text-muted">объектов</div>
                                        </td>
                                        <td class="text-center">
                                            <strong th:text="${typePercentages.get(entry.key)} + '%'">0%</strong>
                                            <div class="small text-muted">
                                                от общего количества
                                            </div>
                                        </td>
                                        <td class="text-center">
                                                <span th:if="${powerByType.get(entry.key)}"
                                                      th:text="${#numbers.formatDecimal(powerByType.get(entry.key), 1, 2)} + ' МВт'">
                                                    0 МВт
                                                </span>
                                            <span th:unless="${powerByType.get(entry.key)}" class="text-muted">
                                                    0 МВт
                                                </span>
                                        </td>
                                        <td class="text-center">
                                                <span th:if="${avgEfficiencyByType.get(entry.key)}"
                                                      th:text="${#numbers.formatDecimal(avgEfficiencyByType.get(entry.key), 1, 1)} + '%'">
                                                    0%
                                                </span>
                                            <span th:unless="${avgEfficiencyByType.get(entry.key)}" class="text-muted">
                                                    -
                                                </span>
                                        </td>
                                        <td>
                                            <div class="distribution-bar">
                                                <div class="distribution-fill"
                                                     th:style="'width: ' + ${typePercentages.get(entry.key)} + '%;'"></div>
                                            </div>
                                            <div class="small text-muted text-center mt-1">
                                                <span th:text="${typePercentages.get(entry.key)} + '%'">0%</span>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                    <tfoot class="table-light">
                                    <tr>
                                        <th>Итого</th>
                                        <th class="text-center" th:text="${totalObjects}">0</th>
                                        <th class="text-center">100%</th>
                                        <th class="text-center" th:text="${#numbers.formatDecimal(totalPower, 1, 2)} + ' МВт'">0 МВт</th>
                                        <th class="text-center" th:text="${#numbers.formatDecimal(averageEfficiency, 1, 1)} + '%'">0%</th>
                                        <th>
                                            <div class="distribution-bar">
                                                <div class="distribution-fill" style="width: 100%"></div>
                                            </div>
                                        </th>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Сравнительная информация -->
            <div class="row mt-4">
                <div class="col-md-6 mb-4">
                    <div class="comparison-card">
                        <h5 class="text-white mb-3">
                            <i class="bi bi-graph-up-arrow me-2"></i>
                            Показатели эффективности
                        </h5>
                        <div class="row text-center">
                            <div class="col-6">
                                <p class="comparison-value" th:text="${#numbers.formatDecimal(averagePower, 1, 2)}">0</p>
                                <p class="comparison-label">Средняя мощность (МВт)</p>
                            </div>
                            <div class="col-6">
                                <p class="comparison-value" th:text="${#numbers.formatDecimal(averageEfficiency, 1, 1)} + '%'">0%</p>
                                <p class="comparison-label">Средний КПД</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-info-circle text-primary me-2"></i>
                                Краткая информация
                            </h5>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <strong>Активных объектов:</strong>
                                    <span th:text="${activeObjects} + ' (' + ${activePercentage} + '%)'">0 (0%)</span>
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-x-circle text-danger me-2"></i>
                                    <strong>Неактивных объектов:</strong>
                                    <span th:text="${inactiveObjects} + ' (' + ${inactivePercentage} + '%)'">0 (0%)</span>
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-lightning text-warning me-2"></i>
                                    <strong>Общая мощность активных:</strong>
                                    <span th:text="${#numbers.formatDecimal(totalActivePower, 1, 2)} + ' МВт'">0 МВт</span>
                                </li>
                                <li>
                                    <i class="bi bi-building text-info me-2"></i>
                                    <strong>Разнообразие типов:</strong>
                                    <span th:text="${typeCounts.size()}">0</span> различных типов
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="row mt-4 no-print">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <div>
                        <a th:href="@{/energy-objects}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-1"></i>Назад к объектам
                        </a>
                        <button onclick="location.reload()" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-arrow-clockwise me-1"></i>Обновить
                        </button>
                    </div>
                    <div>
                        <a th:href="@{/}" class="btn btn-outline-dark">
                            <i class="bi bi-house me-1"></i>На главную
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Скрипты -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // Получаем данные из Thymeleaf переменных
        const typeCounts = /*[[${typeCounts}]]*/ {};
        const typePercentages = /*[[${typePercentages}]]*/ {};
        const powerByType = /*[[${powerByType}]]*/ {};
        const activeObjects = /*[[${activeObjects}]]*/ 0;
        const inactiveObjects = /*[[${inactiveObjects}]]*/ 0;

        // Преобразуем Map в массивы для Chart.js
        const typeLabels = [];
        const typeData = [];
        const typeColors = [];
        const powerData = [];

        // Цвета для типов (максимум 8 типов)
        const colorPalette = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
            '#9966FF', '#FF9F40', '#C9CBCF', '#77DD77'
        ];

        // Заполняем массивы данными
        let colorIndex = 0;
        for (const [type, count] of Object.entries(typeCounts)) {
            typeLabels.push(type);
            typeData.push(count);
            powerData.push(powerByType[type] || 0);
            typeColors.push(colorPalette[colorIndex % colorPalette.length]);
            colorIndex++;
        }

        // 1. Круговая диаграмма распределения по типам
        const typeCtx = document.getElementById('typeDistributionChart');
        if (typeCtx && typeLabels.length > 0) {
            new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        data: typeData,
                        backgroundColor: typeColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} объектов (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        } else if (typeCtx) {
            // Если нет данных, показываем сообщение
            typeCtx.style.display = 'none';
            const parent = typeCtx.parentElement;
            const message = document.createElement('div');
            message.className = 'text-center text-muted';
            message.innerHTML = '<i class="bi bi-bar-chart" style="font-size: 2rem;"></i><p class="mt-2">Нет данных для графика</p>';
            parent.appendChild(message);
        }

        // 2. Диаграмма статусов (активные/неактивные)
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx && (activeObjects > 0 || inactiveObjects > 0)) {
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Активные', 'Неактивные'],
                    datasets: [{
                        data: [activeObjects, inactiveObjects],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} объектов (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        } else if (statusCtx) {
            statusCtx.style.display = 'none';
            const parent = statusCtx.parentElement;
            const message = document.createElement('div');
            message.className = 'text-center text-muted';
            message.innerHTML = '<i class="bi bi-pie-chart" style="font-size: 2rem;"></i><p class="mt-2">Нет данных о статусах</p>';
            parent.appendChild(message);
        }

        // 3. Гистограмма мощности по типам (добавьте этот canvas в HTML если нужно)
        const powerCtx = document.getElementById('powerChart');
        if (powerCtx && typeLabels.length > 0) {
            new Chart(powerCtx, {
                type: 'bar',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        label: 'Мощность (МВт)',
                        data: powerData,
                        backgroundColor: typeColors,
                        borderColor: typeColors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Мощность (МВт)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    });
    /*]]>*/
</script>
</body>
</html>